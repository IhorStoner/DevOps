pipeline {
    agent any

    parameters{
        string(name: 'BRANCH', defaultValue:'master',  description: 'If you need custom build - type the tag or custom branch and select desired Run Type' )
    }

    stages {
        stage('Docker Build') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    sh 'docker login -u=$DOCKER_USERNAME -p=$DOCKER_PASSWORD'
                }
                 def scmGit = checkout(
                    poll: false,
                    changelog:false,
                    scm: [
                        branches: [[name: params.BRANCH]],
                        userRemoteConfigs: [[url: 'git@github.com:IhorStoner/bangok.git', credentialsId: "ssh-github"]],
                    ]
                ])

                sh 'docker build . --file Dockerfile --tag ihorstoner/bangok:latest'
                sh 'docker push ihorstoner/bangok:latest'
            }
        }
        stage('Deploy') {
            steps {
                sh 'docker pull ihorstoner/bangok:latest'
                sh 'docker run --name docker_hw -d -p 5000:5000 --env ORIGIN_URI=http://54.189.167.179 ihorstoner/bangok:latest'
            }
        }
    }
}
